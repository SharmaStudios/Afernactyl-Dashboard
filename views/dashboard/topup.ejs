<%- include('../partials/header') %>
    <%- include('../partials/sidebar') %>

        <div class="main-content">
            <div class="container animate-fade-in">
                <h1 class="page-title"><i class="fa-solid fa-wallet"></i> Add Funds</h1>

                <% if (error_msg && error_msg.length> 0) { %>
                    <div class="alert alert-error">
                        <%= error_msg %>
                    </div>
                    <% } %>

                        <div class="topup-grid">
                            <div class="card topup-form-card">
                                <h2><i class="fa-solid fa-plus-circle"></i> Top Up Your Balance</h2>
                                <form action="/dashboard/topup" method="POST" id="topupForm">
                                    <div class="form-group">
                                        <label class="form-label">Amount (USD)</label>
                                        <div class="amount-input-group">
                                            <span class="currency-prefix">$</span>
                                            <input type="number" name="amount" id="amount" class="form-input" min="5"
                                                max="1000" step="0.01" value="10" required onchange="updateSummary()">
                                            <span class="currency-suffix">USD</span>
                                        </div>
                                        <small class="form-hint">Minimum: $5.00 | Maximum: $1,000.00</small>
                                    </div>

                                    <div class="quick-amounts">
                                        <button type="button" class="quick-amount-btn"
                                            onclick="setAmount(5)">$5</button>
                                        <button type="button" class="quick-amount-btn"
                                            onclick="setAmount(10)">$10</button>
                                        <button type="button" class="quick-amount-btn"
                                            onclick="setAmount(25)">$25</button>
                                        <button type="button" class="quick-amount-btn"
                                            onclick="setAmount(50)">$50</button>
                                        <button type="button" class="quick-amount-btn"
                                            onclick="setAmount(100)">$100</button>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label"><i class="fa-solid fa-credit-card"></i> Payment
                                            Method</label>
                                        <div class="payment-methods">
                                            <% if (gateways.length===0) { %>
                                                <div class="alert alert-warning">
                                                    <i class="fa-solid fa-circle-exclamation"></i>
                                                    No payment gateways are currently configured. Please contact
                                                    support.
                                                </div>
                                                <% } else { %>
                                                    <% gateways.forEach(function(gateway, index) { %>
                                                        <label class="payment-option">
                                                            <input type="radio" name="payment_method"
                                                                value="<%= gateway.name %>" <%=index===0 ? 'checked'
                                                                : '' %>>
                                                            <div class="payment-option-content">
                                                                <% if (gateway.name==='stripe' ) { %>
                                                                    <i class="fa-brands fa-stripe fa-lg"></i>
                                                                    <% } else if (gateway.name==='paypal' ) { %>
                                                                        <i class="fa-brands fa-paypal fa-lg"></i>
                                                                        <% } else if (gateway.name==='phonepe' ) { %>
                                                                            <i
                                                                                class="fa-solid fa-mobile-screen-button fa-lg"></i>
                                                                            <% } else { %>
                                                                                <i
                                                                                    class="fa-solid fa-credit-card fa-lg"></i>
                                                                                <% } %>
                                                                                    <div>
                                                                                        <strong>
                                                                                            <%= gateway.display_name ||
                                                                                                gateway.name %>
                                                                                        </strong>
                                                                                    </div>
                                                            </div>
                                                        </label>
                                                        <% }); %>
                                                            <% } %>
                                        </div>
                                    </div>

                                    <% if (gateways.length> 0) { %>
                                        <button type="submit" class="btn btn-primary btn-block btn-lg">
                                            <i class="fa-solid fa-lock"></i> Proceed to Payment
                                        </button>
                                        <% } %>
                                </form>
                            </div>

                            <div class="card summary-card">
                                <h2><i class="fa-solid fa-receipt"></i> Summary</h2>

                                <div class="current-balance">
                                    <span class="label">Current Balance</span>
                                    <span class="value">$<%= parseFloat(user.balance).toFixed(2) %> USD</span>
                                </div>

                                <hr class="divider">

                                <div class="topup-summary">
                                    <div class="summary-row">
                                        <span>Top Up Amount</span>
                                        <span id="summaryAmount">$10.00 USD</span>
                                    </div>
                                    <hr class="divider">
                                    <div class="summary-row total">
                                        <span>New Balance After</span>
                                        <span id="newBalance" class="new-balance">$<%= (parseFloat(user.balance) +
                                                10).toFixed(2) %> USD</span>
                                    </div>
                                </div>

                                <div class="info-box">
                                    <i class="fa-solid fa-info-circle"></i>
                                    <p>Funds are added instantly after successful payment. Your balance is stored in USD
                                        and can be used for any service.</p>
                                </div>
                            </div>
                        </div>
            </div>
        </div>

        <script>
            const currentBalance = <%= parseFloat(user.balance) %>;

            function setAmount(amount) {
                document.getElementById('amount').value = amount;
                updateSummary();
            }

            function updateSummary() {
                const amount = parseFloat(document.getElementById('amount').value) || 0;
                document.getElementById('summaryAmount').textContent = '$' + amount.toFixed(2) + ' USD';
                document.getElementById('newBalance').textContent = '$' + (currentBalance + amount).toFixed(2) + ' USD';
            }

            // Initialize
            updateSummary();
        </script>

        <style>
            .topup-grid {
                display: grid;
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }

            @media (max-width: 768px) {
                .topup-grid {
                    grid-template-columns: 1fr;
                }
            }

            .topup-form-card h2,
            .summary-card h2 {
                margin-bottom: 1.5rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .topup-form-card h2 i,
            .summary-card h2 i {
                color: var(--accent);
            }

            .amount-input-group {
                display: flex;
                align-items: center;
                background: rgba(255, 255, 255, 0.03);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 0.5rem;
                overflow: hidden;
            }

            .currency-prefix,
            .currency-suffix {
                padding: 0.75rem 1rem;
                background: rgba(255, 255, 255, 0.05);
                color: var(--text-secondary);
                font-weight: 600;
            }

            .amount-input-group .form-input {
                border: none;
                background: transparent;
                text-align: center;
                font-size: 1.5rem;
                font-weight: 700;
                flex: 1;
            }

            .amount-input-group .form-input:focus {
                box-shadow: none;
            }

            .form-hint {
                display: block;
                margin-top: 0.5rem;
                color: var(--text-secondary);
                font-size: 0.85rem;
            }

            .quick-amounts {
                display: flex;
                gap: 0.5rem;
                margin-bottom: 1.5rem;
                flex-wrap: wrap;
            }

            .quick-amount-btn {
                flex: 1;
                min-width: 60px;
                padding: 0.75rem;
                background: rgba(255, 255, 255, 0.05);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 0.5rem;
                color: var(--text-primary);
                font-weight: 600;
                cursor: pointer;
                transition: all 0.2s;
            }

            .quick-amount-btn:hover {
                background: rgba(59, 130, 246, 0.2);
                border-color: var(--accent);
            }

            .payment-methods {
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }

            .payment-option {
                cursor: pointer;
                display: block;
            }

            .payment-option input {
                display: none;
            }

            .payment-option-content {
                display: flex;
                align-items: center;
                gap: 1rem;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.02);
                border: 2px solid rgba(255, 255, 255, 0.1);
                border-radius: 0.75rem;
                transition: all 0.2s;
            }

            .payment-option input:checked+.payment-option-content {
                border-color: var(--accent);
                background: rgba(59, 130, 246, 0.1);
            }

            .payment-option-content i {
                font-size: 1.5rem;
                width: 40px;
                text-align: center;
                color: var(--accent);
            }

            .btn-lg {
                padding: 1rem 2rem;
                font-size: 1.1rem;
            }

            .current-balance {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 0.5rem;
            }

            .current-balance .label {
                color: var(--text-secondary);
            }

            .current-balance .value {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--accent);
            }

            .divider {
                border: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                margin: 1.5rem 0;
            }

            .summary-row {
                display: flex;
                justify-content: space-between;
                padding: 0.5rem 0;
                color: var(--text-secondary);
            }

            .summary-row.total {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text-primary);
            }

            .new-balance {
                color: #10b981 !important;
            }

            .info-box {
                display: flex;
                gap: 0.75rem;
                padding: 1rem;
                background: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.3);
                border-radius: 0.5rem;
                margin-top: 1.5rem;
            }

            .info-box i {
                color: var(--accent);
                font-size: 1.25rem;
                flex-shrink: 0;
            }

            .info-box p {
                margin: 0;
                color: var(--text-secondary);
                font-size: 0.9rem;
                line-height: 1.5;
            }
        </style>

        <%- include('../partials/footer') %>