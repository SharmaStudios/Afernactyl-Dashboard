<%- include('../partials/header') %>
    <%- include('../partials/sidebar') %>

        <div class="main-content">
            <div class="container animate-fade-in" style="max-width: 900px;">
                <h1 class="page-title"><i class="fa-solid fa-bullhorn"></i> Email Broadcast</h1>

                <% if (success_msg && success_msg.length> 0) { %>
                    <div class="alert alert-success">
                        <%= success_msg %>
                    </div>
                    <% } %>
                        <% if (error_msg && error_msg.length> 0) { %>
                            <div class="alert alert-error">
                                <%= error_msg %>
                            </div>
                            <% } %>

                                <div class="card">
                                    <form action="/admin/broadcast" method="POST" id="broadcastForm">
                                        <div class="form-group">
                                            <label class="form-label">Subject</label>
                                            <input type="text" name="subject" class="form-control" required
                                                placeholder="e.g. System Maintenance Notice">
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Recipients</label>
                                                    <select name="recipient_type" class="form-control"
                                                        id="recipientType">
                                                        <option value="all">All Users (<%= userCount %> users)</option>
                                                        <option value="active">Users with Active Servers</option>
                                                        <option value="admins">Admins Only</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Email Type</label>
                                                    <select name="email_type" class="form-control">
                                                        <option value="announcement">Announcement</option>
                                                        <option value="maintenance">Maintenance</option>
                                                        <option value="urgent">Urgent</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Message Content</label>
                                            <div id="editor" style="min-height: 200px;"></div>
                                            <input type="hidden" name="content" id="contentInput">
                                        </div>

                                        <div class="form-group mt-3">
                                            <label class="checkbox-label" style="cursor: pointer;">
                                                <input type="checkbox" name="send_test" id="sendTest">
                                                <i class="fa-solid fa-flask mr-2"></i> Send test email to me first
                                            </label>
                                        </div>

                                        <div class="d-flex justify-content-between align-items-center mt-4">
                                            <a href="/admin" class="btn btn-secondary"><i
                                                    class="fa-solid fa-arrow-left mr-2"></i>Back</a>
                                            <button type="submit" class="btn btn-primary" id="sendBtn">
                                                <i class="fa-solid fa-paper-plane mr-2"></i>Send Broadcast
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Preview Section -->
                                <div class="card mt-4" id="previewCard" style="display: none;">
                                    <h3><i class="fa-solid fa-eye mr-2"></i>Preview</h3>
                                    <div id="preview"
                                        style="background: white; color: #333; padding: 1.5rem; border-radius: 8px; margin-top: 1rem;">
                                    </div>
                                </div>

                                <!-- Broadcast History -->
                                <% if (logs && logs.length> 0) { %>
                                    <div class="card mt-4">
                                        <h3><i class="fa-solid fa-clock-rotate-left mr-2"></i>Recent Broadcasts</h3>
                                        <div class="table-responsive mt-3">
                                            <table class="table">
                                                <thead>
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Sent By</th>
                                                        <th>Subject</th>
                                                        <th>Type</th>
                                                        <th>Recipients</th>
                                                        <th>Sent/Failed</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <% logs.forEach(log=> { %>
                                                        <tr>
                                                            <td class="text-muted">
                                                                <%= new Date(log.created_at).toLocaleString() %>
                                                            </td>
                                                            <td>
                                                                <%= log.admin_username %>
                                                            </td>
                                                            <td
                                                                style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                                                <%= log.subject %>
                                                            </td>
                                                            <td>
                                                                <% if (log.email_type==='announcement' ) { %>
                                                                    <span class="status-badge active"><i
                                                                            class="fa-solid fa-bullhorn"></i></span>
                                                                    <% } else if (log.email_type==='maintenance' ) { %>
                                                                        <span class="status-badge pending"
                                                                            style="background: rgba(251, 191, 36, 0.2); color: #fbbf24;"><i
                                                                                class="fa-solid fa-wrench"></i></span>
                                                                        <% } else if (log.email_type==='urgent' ) { %>
                                                                            <span class="status-badge suspended"><i
                                                                                    class="fa-solid fa-triangle-exclamation"></i></span>
                                                                            <% } %>
                                                            </td>
                                                            <td>
                                                                <% if (log.recipient_type==='all' ) { %>All Users
                                                                    <% } else if (log.recipient_type==='active' ) { %>
                                                                        Active Servers
                                                                        <% } else { %>Admins<% } %>
                                                            </td>
                                                            <td>
                                                                <span style="color: var(--color-success);">
                                                                    <%= log.sent_count %>
                                                                </span> /
                                                                <span style="color: var(--color-danger);">
                                                                    <%= log.failed_count %>
                                                                </span>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <% } %>
            </div>
        </div>

        <!-- Quill Rich Text Editor -->
        <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
        <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>

        <style>
            .ql-toolbar.ql-snow {
                border: 1px solid var(--glass-border);
                border-radius: 8px 8px 0 0;
                background: rgba(255, 255, 255, 0.05);
            }

            .ql-container.ql-snow {
                border: 1px solid var(--glass-border);
                border-top: none;
                border-radius: 0 0 8px 8px;
                background: rgba(0, 0, 0, 0.2);
                min-height: 200px;
            }

            .ql-editor {
                color: var(--color-text);
                min-height: 200px;
            }

            .ql-editor.ql-blank::before {
                color: var(--color-text-dim);
            }

            .ql-snow .ql-stroke {
                stroke: var(--color-text-dim);
            }

            .ql-snow .ql-fill {
                fill: var(--color-text-dim);
            }

            .ql-snow .ql-picker {
                color: var(--color-text-dim);
            }
        </style>

        <script>
            const quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Write your email content here...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'align': [] }],
                        ['link'],
                        ['blockquote'],
                        ['clean']
                    ]
                }
            });

            document.getElementById('broadcastForm').addEventListener('submit', function (e) {
                const content = quill.root.innerHTML;
                if (content === '<p><br></p>' || content.trim() === '') {
                    e.preventDefault();
                    alert('Please enter email content');
                    return false;
                }
                document.getElementById('contentInput').value = content;

                const sendTest = document.getElementById('sendTest').checked;
                if (!sendTest) {
                    const recipientType = document.getElementById('recipientType').value;
                    let msg = 'Are you sure you want to send this email to ';
                    if (recipientType === 'all') msg += 'ALL users';
                    else if (recipientType === 'active') msg += 'users with active servers';
                    else msg += 'admins only';
                    msg += '? This cannot be undone.';

                    if (!confirm(msg)) {
                        e.preventDefault();
                        return false;
                    }
                }

                const btn = document.getElementById('sendBtn');
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';
            });

            quill.on('text-change', function () {
                const content = quill.root.innerHTML;
                const previewCard = document.getElementById('previewCard');
                const preview = document.getElementById('preview');

                if (content !== '<p><br></p>' && content.trim() !== '') {
                    preview.innerHTML = content;
                    previewCard.style.display = 'block';
                } else {
                    previewCard.style.display = 'none';
                }
            });
        </script>

        <%- include('../partials/footer') %>