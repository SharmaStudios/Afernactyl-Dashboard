<%- include('../partials/header') %>
    <%- include('../partials/sidebar') %>

        <div class="main-content">
            <div class="container animate-fade-in">
                <div class="flex-between mb-4">
                    <h1 class="page-title"><i class="fa-solid fa-money-bill-transfer"></i> Payout Management</h1>
                    <a href="/admin/affiliates" class="btn btn-secondary">
                        <i class="fa-solid fa-arrow-left mr-2"></i>Back to Affiliates
                    </a>
                </div>

                <% if (success_msg && success_msg.length> 0) { %>
                    <div class="alert alert-success">
                        <%= success_msg %>
                    </div>
                    <% } %>
                        <% if (error_msg && error_msg.length> 0) { %>
                            <div class="alert alert-error">
                                <%= error_msg %>
                            </div>
                            <% } %>

                                <!-- Stats Overview -->
                                <div class="stats-grid mb-4">
                                    <div class="stat-card fade-in">
                                        <div class="stat-icon"
                                            style="background: linear-gradient(135deg, #fbbf24, #f59e0b);"><i
                                                class="fa-solid fa-clock"></i></div>
                                        <div class="stat-info">
                                            <h3>Pending</h3>
                                            <div class="value">
                                                <%= payouts.filter(p=> p.status === 'pending').length %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="stat-card fade-in" style="animation-delay: 0.1s;">
                                        <div class="stat-icon"
                                            style="background: linear-gradient(135deg, #22c55e, #16a34a);"><i
                                                class="fa-solid fa-check-circle"></i></div>
                                        <div class="stat-info">
                                            <h3>Completed</h3>
                                            <div class="value">
                                                <%= payouts.filter(p=> p.status === 'paid').length %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="stat-card fade-in" style="animation-delay: 0.2s;">
                                        <div class="stat-icon"
                                            style="background: linear-gradient(135deg, #ef4444, #dc2626);"><i
                                                class="fa-solid fa-times-circle"></i></div>
                                        <div class="stat-info">
                                            <h3>Rejected</h3>
                                            <div class="value">
                                                <%= payouts.filter(p=> p.status === 'rejected').length %>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Payouts Table -->
                                <div class="card card-table">
                                    <% if (payouts.length===0) { %>
                                        <div style="text-align: center; color: var(--text-muted); padding: 2rem;">No
                                            payout requests found.</div>
                                        <% } else { %>
                                            <div class="table-wrap">
                                                <table class="data-table">
                                                    <thead>
                                                        <tr>
                                                            <th>User</th>
                                                            <th>Referral Code</th>
                                                            <th>Amount</th>
                                                            <th>Method</th>
                                                            <th>Status</th>
                                                            <th>Requested</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% payouts.forEach(payout=> { %>
                                                            <tr>
                                                                <td><span style="font-weight: 600;">
                                                                        <%= payout.username %>
                                                                    </span></td>
                                                                <td>
                                                                    <code
                                                                        style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.5rem; border-radius: 4px;"><%= payout.referral_code %></code>
                                                                </td>
                                                                <td
                                                                    style="color: var(--color-warning); font-weight: 600;">
                                                                    $<%= parseFloat(payout.amount).toFixed(2) %>
                                                                </td>
                                                                <td>
                                                                    <span class="badge badge-user"
                                                                        style="text-transform: uppercase;">
                                                                        <%= payout.payment_method %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <span
                                                                        class="badge <%= payout.status === 'paid' ? 'badge-active' : payout.status === 'pending' ? 'badge-pending' : 'badge-suspended' %>">
                                                                        <%= payout.status.charAt(0).toUpperCase() +
                                                                            payout.status.slice(1) %>
                                                                    </span>
                                                                </td>
                                                                <td>
                                                                    <%= new Date(payout.created_at).toLocaleDateString()
                                                                        %>
                                                                </td>
                                                                <td>
                                                                    <% if (payout.status==='pending' ) { %>
                                                                        <div class="action-buttons">
                                                                            <form
                                                                                action="/admin/payouts/<%= payout.id %>/approve"
                                                                                method="POST" style="display: inline;"
                                                                                onsubmit="return confirm('Mark this payout as PAID?')">
                                                                                <button type="submit"
                                                                                    class="btn btn-sm btn-success"
                                                                                    title="Approve & Mark Paid">
                                                                                    <i class="fa-solid fa-check"></i>
                                                                                </button>
                                                                            </form>
                                                                            <form
                                                                                action="/admin/payouts/<%= payout.id %>/reject"
                                                                                method="POST" style="display: inline;"
                                                                                onsubmit="return confirm('REJECT this payout? Balance will be refunded.')">
                                                                                <button type="submit"
                                                                                    class="btn btn-sm btn-danger"
                                                                                    title="Reject">
                                                                                    <i class="fa-solid fa-times"></i>
                                                                                </button>
                                                                            </form>
                                                                        </div>
                                                                        <% } else if (payout.paid_at) { %>
                                                                            <span
                                                                                style="color: var(--color-text-muted); font-size: 0.8rem;">
                                                                                <i
                                                                                    class="fa-solid fa-calendar-check mr-1"></i>
                                                                                <%= new
                                                                                    Date(payout.paid_at).toLocaleDateString()
                                                                                    %>
                                                                            </span>
                                                                            <% } else { %>
                                                                                <span
                                                                                    style="color: var(--color-text-muted);">â€”</span>
                                                                                <% } %>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <% } %>
                                </div>
            </div>
        </div>

        <%- include('../partials/footer') %>