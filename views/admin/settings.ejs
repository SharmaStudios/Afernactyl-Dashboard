<%- include('../partials/header') %>
    <%- include('../partials/sidebar') %>

        <div class="main-content">
            <div class="container animate-fade-in" style="max-width: 900px;">
                <h1 class="page-title"><i class="fa-solid fa-gears"></i> System Settings</h1>

                <% if (error_msg && error_msg.length> 0) { %>
                    <div class="alert alert-error">
                        <%= error_msg %>
                    </div>
                    <% } %>
                        <% if (success_msg && success_msg.length> 0) { %>
                            <div class="alert alert-success">
                                <%= success_msg %>
                            </div>
                            <% } %>

                                <form action="/admin/settings" method="POST">
                                    <!-- Branding -->
                                    <div class="card mb-4" style="border-left: 4px solid #8b5cf6;">
                                        <h2 class="section-title"><i class="fa-solid fa-palette"></i> Branding</h2>
                                        <p class="text-muted mb-4">Customize the dashboard name and logo appearing
                                            across the platform.</p>

                                        <div class="form-group">
                                            <label class="form-label">Site Name</label>
                                            <input type="text" name="site_name" class="form-control"
                                                value="<%= settings.site_name || 'Afernactyl' %>"
                                                placeholder="e.g. My Hosting">
                                            <small class="text-muted">Displayed in the sidebar and browser title</small>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Logo URL (Optional)</label>
                                            <input type="text" name="site_logo" class="form-control"
                                                value="<%= settings.site_logo || '' %>"
                                                placeholder="https://example.com/logo.png">
                                            <small class="text-muted">Recommended size: 40x40 pixels. Leave empty for
                                                default icon.</small>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Base Site URL</label>
                                            <input type="url" name="site_url" class="form-control"
                                                value="<%= settings.site_url || '' %>"
                                                placeholder="https://dash.example.com">
                                            <small class="text-muted">Crucial for OAuth callbacks and emails. Include
                                                http/https and no trailing slash.</small>
                                            <% if (!settings.site_url) { %>
                                                <div class="mt-2"
                                                    style="color: var(--color-warning); font-size: 0.8rem;">
                                                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> You must set
                                                    this URL for Discord/Google logins to work!
                                                </div>
                                                <% } %>
                                        </div>

                                        <div class="form-group">
                                            <label class="form-label">Preview</label>
                                            <div
                                                style="background: rgba(0,0,0,0.3); padding: 1.25rem; border-radius: 12px; display: inline-flex; align-items: center; gap: 1rem; border: 1px solid var(--glass-border);">
                                                <% if (settings.site_logo) { %>
                                                    <img src="<%= settings.site_logo %>" alt="Logo"
                                                        style="height: 32px; width: 32px; object-fit: contain;">
                                                    <% } else { %>
                                                        <div
                                                            style="height: 32px; width: 32px; display: flex; align-items: center; justify-content: center; background: var(--color-primary-glow); border-radius: 8px;">
                                                            <i class="fa-solid fa-dragon"
                                                                style="font-size: 1.2rem; color: #8b5cf6;"></i>
                                                        </div>
                                                        <% } %>
                                                            <span style="font-weight: 700; font-size: 1.2rem;">
                                                                <%= settings.site_name || 'Afernactyl' %>
                                                            </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Core Configuration -->
                                    <div class="card mb-4" style="border-left: 4px solid var(--color-primary);">
                                        <h2 class="section-title"><i class="fa-solid fa-wrench"></i> Core Configuration
                                        </h2>

                                        <div class="toggle-row">
                                            <div>
                                                <span class="font-bold d-block">Maintenance Mode</span>
                                                <small class="text-muted">Prevents non-admin users from accessing the
                                                    dashboard.</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" name="maintenance" value="true"
                                                    <%=settings.maintenance==='true' ? 'checked' : '' %>>
                                                <span class="slider round"></span>
                                            </label>
                                        </div>

                                        <div class="toggle-row mt-3">
                                            <div>
                                                <span class="font-bold d-block">Debug Mode</span>
                                                <small class="text-muted">Enables verbose logging to the server
                                                    terminal.</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" name="debug_mode" value="true"
                                                    <%=settings.debug_mode==='true' ? 'checked' : '' %>>
                                                <span class="slider round"></span>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Affiliate Program -->
                                    <div class="card mb-4" style="border-left: 4px solid #a855f7;">
                                        <h2 class="section-title"><i class="fa-solid fa-people-group"></i> Affiliate
                                            Program</h2>
                                        <p class="text-muted mb-4">Configure the referral/affiliate program settings.
                                        </p>

                                        <div class="toggle-row">
                                            <div>
                                                <span class="font-bold d-block">Enable Affiliate Program</span>
                                                <small class="text-muted">Allow users to become affiliates and earn
                                                    commissions.</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" name="affiliate_enabled" value="true"
                                                    <%=settings.affiliate_enabled==='true' ? 'checked' : '' %>>
                                                <span class="slider round"></span>
                                            </label>
                                        </div>

                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Default Commission Rate (%)</label>
                                                    <input type="number" name="affiliate_default_commission"
                                                        class="form-control"
                                                        value="<%= settings.affiliate_default_commission || '10' %>"
                                                        min="0" max="100" step="0.1">
                                                    <small class="text-muted">New affiliates get this rate by
                                                        default</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label class="form-label">Minimum Payout ($)</label>
                                                    <input type="number" name="affiliate_min_payout"
                                                        class="form-control"
                                                        value="<%= settings.affiliate_min_payout || '10' %>" min="1"
                                                        step="0.01">
                                                    <small class="text-muted">Minimum balance required to request
                                                        payout</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Global Alert -->
                                    <div class="card mb-4" style="border-left: 4px solid var(--color-warning);">
                                        <h2 class="section-title"><i class="fa-solid fa-bullhorn"></i> Global Alert
                                            Banner</h2>
                                        <p class="text-muted mb-4">Display a site-wide notification to all users.</p>

                                        <% let alert=null; try { alert=settings.global_alert ?
                                            JSON.parse(settings.global_alert) : null; } catch(e) {} %>

                                            <div class="form-group">
                                                <label class="form-label">Alert Message</label>
                                                <input type="text" name="alert_message" class="form-control"
                                                    value="<%= alert ? alert.message : '' %>"
                                                    placeholder="e.g. Server maintenance tonight...">
                                            </div>

                                            <div class="form-group">
                                                <label class="form-label">Alert Severity</label>
                                                <div class="alert-type-grid">
                                                    <label class="alert-type-card">
                                                        <input type="radio" name="alert_type" value="info" <%=!alert ||
                                                            alert.type==='info' ? 'checked' : '' %>>
                                                        <div class="type-content info">
                                                            <i class="fa-solid fa-circle-info"></i>
                                                            <span>Informational</span>
                                                        </div>
                                                    </label>
                                                    <label class="alert-type-card">
                                                        <input type="radio" name="alert_type" value="warning" <%=alert
                                                            && alert.type==='warning' ? 'checked' : '' %>>
                                                        <div class="type-content warning">
                                                            <i class="fa-solid fa-triangle-exclamation"></i>
                                                            <span>Warning</span>
                                                        </div>
                                                    </label>
                                                    <label class="alert-type-card">
                                                        <input type="radio" name="alert_type" value="danger" <%=alert &&
                                                            alert.type==='danger' ? 'checked' : '' %>>
                                                        <div class="type-content danger">
                                                            <i class="fa-solid fa-circle-exclamation"></i>
                                                            <span>Critical</span>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="form-group mt-3">
                                                <label class="danger-zone">
                                                    <input type="checkbox" name="clear_alert" value="1">
                                                    <i class="fa-solid fa-trash-can"></i> Deactivate Current Alert
                                                </label>
                                            </div>
                                    </div>

                                    <!-- Pterodactyl -->
                                    <div class="card mb-4" style="border-left: 4px solid var(--color-info);">
                                        <h2 class="section-title"><i class="fa-solid fa-server"></i> Pterodactyl
                                            Connection</h2>

                                        <div class="form-group">
                                            <label class="form-label">Panel URL</label>
                                            <input type="url" name="ptero_url" class="form-control"
                                                placeholder="https://panel.example.com"
                                                value="<%= settings.ptero_url || '' %>">
                                        </div>

                                        <div class="row">
                                            <div class="<%= radarEnabled ? 'col-md-6' : 'col-md-12' %>">
                                                <div class="form-group">
                                                    <label class="form-label">Application API Key</label>
                                                    <input type="password" name="ptero_key" class="form-control"
                                                        placeholder="ptlc_..." value="<%= settings.ptero_key || '' %>">
                                                </div>
                                            </div>
                                            <% if (radarEnabled) { %>
                                                <div class="col-md-6">
                                                    <div class="form-group">
                                                        <label class="form-label">Client Admin API Key</label>
                                                        <input type="password" name="ptero_client_api_key"
                                                            class="form-control" placeholder="ptla_..."
                                                            value="<%= settings.ptero_client_api_key || '' %>">
                                                    </div>
                                                </div>
                                                <% } %>
                                        </div>
                                        <p class="text-muted text-sm"><i class="fa-solid fa-info-circle mr-1"></i>
                                            Required for server synchronization<%= radarEnabled
                                                ? ' and Radar protection services' : '' %>.</p>
                                    </div>


                                    <!-- OAuth Configuration -->
                                    <div class="card mb-4" style="border-left: 4px solid #6366f1;">
                                        <h2 class="section-title"><i class="fa-solid fa-users-gear"></i> Social
                                            Authentication</h2>
                                        <p class="text-muted mb-4">Manage external login providers. Redirect URIs are
                                            automatically detected.</p>

                                        <div class="oauth-grid">
                                            <!-- GitHub -->
                                            <div class="oauth-card">
                                                <div class="oauth-header">
                                                    <div class="provider-info"><i class="fa-brands fa-github"></i>
                                                        <span>GitHub</span>
                                                    </div>
                                                    <label class="switch">
                                                        <input type="checkbox" name="oauth_github_enabled" value="true"
                                                            <%=settings.oauth_github_enabled==='true' ? 'checked' : ''
                                                            %>>
                                                        <span class="slider round"></span>
                                                    </label>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client ID</label>
                                                    <input type="text" name="oauth_github_client_id"
                                                        class="form-control"
                                                        value="<%= settings.oauth_github_client_id || '' %>">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client Secret</label>
                                                    <div class="secret-input">
                                                        <input type="password" name="oauth_github_client_secret"
                                                            class="form-control"
                                                            value="<%= settings.oauth_github_client_secret || '' %>">
                                                        <i class="fa-solid fa-eye" onclick="toggleSecret(this)"></i>
                                                    </div>
                                                </div>
                                                <div class="callback-footer">
                                                    <span>Callback URI:</span>
                                                    <code class="dynamic-url"
                                                        data-path="/auth/github/callback">Loading...</code>
                                                </div>
                                            </div>

                                            <!-- Discord -->
                                            <div class="oauth-card">
                                                <div class="oauth-header">
                                                    <div class="provider-info" style="color: #5865F2;"><i
                                                            class="fa-brands fa-discord"></i> <span>Discord</span></div>
                                                    <label class="switch">
                                                        <input type="checkbox" name="oauth_discord_enabled" value="true"
                                                            <%=settings.oauth_discord_enabled==='true' ? 'checked' : ''
                                                            %>>
                                                        <span class="slider round"></span>
                                                    </label>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client ID</label>
                                                    <input type="text" name="oauth_discord_client_id"
                                                        class="form-control"
                                                        value="<%= settings.oauth_discord_client_id || '' %>">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client Secret</label>
                                                    <div class="secret-input">
                                                        <input type="password" name="oauth_discord_client_secret"
                                                            class="form-control"
                                                            value="<%= settings.oauth_discord_client_secret || '' %>">
                                                        <i class="fa-solid fa-eye" onclick="toggleSecret(this)"></i>
                                                    </div>
                                                </div>
                                                <div class="callback-footer">
                                                    <span>Callback URI:</span>
                                                    <code class="dynamic-url"
                                                        data-path="/auth/discord/callback">Loading...</code>
                                                </div>
                                            </div>

                                            <!-- Google -->
                                            <div class="oauth-card">
                                                <div class="oauth-header">
                                                    <div class="provider-info" style="color: #ea4335;"><i
                                                            class="fa-brands fa-google"></i> <span>Google</span></div>
                                                    <label class="switch">
                                                        <input type="checkbox" name="oauth_google_enabled" value="true"
                                                            <%=settings.oauth_google_enabled==='true' ? 'checked' : ''
                                                            %>>
                                                        <span class="slider round"></span>
                                                    </label>
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client ID</label>
                                                    <input type="text" name="oauth_google_client_id"
                                                        class="form-control"
                                                        value="<%= settings.oauth_google_client_id || '' %>">
                                                </div>
                                                <div class="form-group">
                                                    <label class="form-label text-sm">Client Secret</label>
                                                    <div class="secret-input">
                                                        <input type="password" name="oauth_google_client_secret"
                                                            class="form-control"
                                                            value="<%= settings.oauth_google_client_secret || '' %>">
                                                        <i class="fa-solid fa-eye" onclick="toggleSecret(this)"></i>
                                                    </div>
                                                </div>
                                                <div class="callback-footer">
                                                    <span>Callback URI:</span>
                                                    <code class="dynamic-url"
                                                        data-path="/auth/google/callback">Loading...</code>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Webhooks -->
                                    <div class="card mb-4" style="border-left: 4px solid var(--color-info);">
                                        <h2 class="section-title"><i class="fa-solid fa-bolt"></i> Global Notifications
                                        </h2>
                                        <div class="form-group">
                                            <label class="form-label">Discord Webhook URL</label>
                                            <input type="url" name="discord_webhook_url" class="form-control"
                                                value="<%= settings.discord_webhook_url || '' %>"
                                                placeholder="https://discord.com/api/webhooks/...">
                                        </div>
                                        <button type="button" onclick="testDiscordWebhook()"
                                            class="btn btn-secondary btn-sm">
                                            <i class="fa-solid fa-paper-plane mr-1"></i> Send Test Notification
                                        </button>
                                    </div>

                                    <!-- Save Button -->
                                    <div class="save-actions">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fa-solid fa-save mr-2"></i> Save All Settings
                                        </button>
                                    </div>
                                </form>
            </div>
        </div>

        <style>
            .toggle-row {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: rgba(255, 255, 255, 0.03);
                padding: 1rem;
                border-radius: 12px;
                border: 1px solid var(--glass-border);
            }

            .oauth-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 1.5rem;
            }

            .oauth-card {
                background: rgba(0, 0, 0, 0.3);
                padding: 1.5rem;
                border-radius: 12px;
                border: 1px solid var(--glass-border);
                transition: transform 0.2s, border-color 0.2s;
            }

            .oauth-card:hover {
                transform: translateY(-3px);
                border-color: rgba(255, 255, 255, 0.2);
            }

            .oauth-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                margin-bottom: 1.25rem;
            }

            .provider-info {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                font-weight: 700;
                font-size: 1.1rem;
            }

            .provider-info i {
                font-size: 1.5rem;
            }

            .secret-input {
                position: relative;
            }

            .secret-input i {
                position: absolute;
                right: 1rem;
                top: 50%;
                transform: translateY(-50%);
                cursor: pointer;
                color: var(--color-text-dim);
            }

            .callback-footer {
                margin-top: 1rem;
                padding-top: 0.75rem;
                border-top: 1px solid rgba(255, 255, 255, 0.05);
                font-size: 0.75rem;
                color: var(--color-text-dim);
            }

            .callback-footer code {
                display: block;
                margin-top: 0.25rem;
                background: rgba(0, 0, 0, 0.4);
                padding: 0.4rem 0.6rem;
                border-radius: 6px;
                color: var(--color-primary);
                word-break: break-all;
            }

            .alert-type-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 1rem;
            }

            .alert-type-card input {
                display: none;
            }

            .type-content {
                padding: 1rem;
                border-radius: 12px;
                border: 2px solid var(--glass-border);
                background: rgba(255, 255, 255, 0.03);
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                transition: all 0.2s;
            }

            .type-content i {
                font-size: 1.5rem;
            }

            .type-content span {
                font-size: 0.8rem;
                font-weight: 600;
            }

            .alert-type-card input:checked+.type-content.info {
                border-color: var(--color-info);
                background: rgba(14, 165, 233, 0.1);
                color: var(--color-info);
            }

            .alert-type-card input:checked+.type-content.warning {
                border-color: var(--color-warning);
                background: rgba(245, 158, 11, 0.1);
                color: var(--color-warning);
            }

            .alert-type-card input:checked+.type-content.danger {
                border-color: var(--color-danger);
                background: rgba(239, 68, 68, 0.1);
                color: var(--color-danger);
            }

            .danger-zone {
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.75rem 1rem;
                border-radius: 8px;
                border: 1px solid rgba(239, 68, 68, 0.3);
                background: rgba(239, 68, 68, 0.1);
                color: var(--color-danger);
                cursor: pointer;
                font-size: 0.9rem;
                font-weight: 600;
            }

            .save-actions {
                position: sticky;
                bottom: 2rem;
                text-align: right;
                margin-top: 2rem;
            }

            .save-actions .btn {
                padding: 1rem 3rem;
                font-size: 1rem;
                box-shadow: 0 8px 30px var(--color-primary-glow);
            }

            @media (max-width: 768px) {
                .alert-type-grid {
                    grid-template-columns: 1fr;
                }

                .oauth-grid {
                    grid-template-columns: 1fr;
                }
            }
        </style>

        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const origin = window.location.origin;
                document.querySelectorAll('.dynamic-url').forEach(code => {
                    code.textContent = origin + code.dataset.path;
                });
            });

            function toggleSecret(el) {
                const input = el.previousElementSibling;
                input.type = input.type === 'password' ? 'text' : 'password';
                el.classList.toggle('fa-eye');
                el.classList.toggle('fa-eye-slash');
            }

            async function testDiscordWebhook() {
                const btn = event.currentTarget;
                const original = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Testing...';

                try {
                    const res = await fetch('/admin/test-discord-webhook', { method: 'POST' });
                    const data = await res.json();
                    alert(data.success ? 'Notification sent successfully!' : 'Failed: ' + (data.error || 'Unknown error'));
                } catch (e) {
                    alert('Network error while testing webhook.');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = original;
                }
            }
        </script>

        <%- include('../partials/footer') %>