<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>
        <%= locals.site_name || 'Afernactyl' %> | Premium Hosting
    </title>
    <% if (locals.site_logo) { %>
        <link rel="icon" type="image/png" href="<%= site_logo %>">
        <% } %>

            <!-- PWA Meta Tags -->
            <meta name="theme-color" content="#6366f1">
            <meta name="description" content="Premium Game Server Hosting Dashboard">
            <meta name="apple-mobile-web-app-capable" content="yes">
            <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
            <meta name="apple-mobile-web-app-title" content="<%= locals.site_name || 'Afernactyl' %>">
            <meta name="mobile-web-app-capable" content="yes">
            <meta name="application-name" content="<%= locals.site_name || 'Afernactyl' %>">
            <meta name="msapplication-TileColor" content="#6366f1">
            <meta name="msapplication-tap-highlight" content="no">

            <!-- PWA Manifest -->
            <link rel="manifest" href="/manifest.json">

            <!-- Apple Touch Icons -->
            <% if (locals.site_logo) { %>
                <link rel="apple-touch-icon" href="<%= site_logo %>">
                <link rel="apple-touch-icon" sizes="152x152" href="<%= site_logo %>">
                <link rel="apple-touch-icon" sizes="180x180" href="<%= site_logo %>">
                <link rel="apple-touch-icon" sizes="167x167" href="<%= site_logo %>">
                <% } else { %>
                    <link rel="apple-touch-icon" href="/icons/icon-152x152.png">
                    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
                    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-192x192.png">
                    <link rel="apple-touch-icon" sizes="167x167" href="/icons/icon-152x152.png">
                    <% } %>

                        <!-- Splash Screens for iOS -->
                        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

                        <!-- Google Fonts -->
                        <link rel="preconnect" href="https://fonts.googleapis.com">
                        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
                            rel="stylesheet">
                        <!-- Font Awesome -->
                        <link rel="stylesheet"
                            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <!-- Custom CSS -->
                        <link rel="stylesheet" href="/css/style.css">

                        <!-- Dynamic Theme Overrides -->
                        <% if (locals.theme && Object.keys(locals.theme).length> 0) { %>
                            <style>
                                :root {
                                    <% Object.keys(theme).forEach(function(key) {
                                            %> <% const varName=key.replace('theme_', '--').replace(/_/g, '-'); %> <%=varName %>: <%=theme[key] %>;
                                            <%
                                        });

                                    %><% if (theme.theme_color_primary) {
                                        %>
                                        /* Derivations for primary color if not explicitly set */
                                        --color-primary-glow: <%=theme.theme_color_primary %>66;
                                        /* 40% opacity hex */
                                        <%
                                    }

                                    %>
                                }
                            </style>
                            <% } %>

                                <!-- Service Worker Registration -->
                                <script>
                                    if ('serviceWorker' in navigator) {
                                        window.addEventListener('load', function () {
                                            navigator.serviceWorker.register('/sw.js')
                                                .then(function (registration) {
                                                    console.log('[PWA] Service Worker registered with scope:', registration.scope);
                                                })
                                                .catch(function (error) {
                                                    console.log('[PWA] Service Worker registration failed:', error);
                                                });
                                        });
                                    }
                                </script>
</head>

<body class="<%= (typeof path !== 'undefined' && path && path.startsWith('/auth')) ? 'auth-page' : '' %>">
    <% if (typeof originalAdmin !=='undefined' && originalAdmin) { %>
        <div class="impersonation-banner">
            <div class="impersonation-content">
                <i class="fa-solid fa-user-secret"></i>
                <span>You are currently impersonating <strong>
                        <%= user ? user.username : 'a user' %>
                    </strong></span>
                <form action="/admin/return-to-admin" method="POST" style="display:inline;">
                    <button type="submit" class="btn-return">
                        <i class="fa-solid fa-arrow-left"></i> Return to Admin
                    </button>
                </form>
            </div>
        </div>
        <style>
            .impersonation-banner {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                color: white;
                padding: 0.5rem 1rem;
                z-index: 10000;
                text-align: center;
            }

            .impersonation-content {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 1rem;
                flex-wrap: wrap;
            }

            .btn-return {
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 0.25rem 0.75rem;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.875rem;
                display: inline-flex;
                align-items: center;
                gap: 0.5rem;
            }

            .btn-return:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            body.impersonating .sidebar,
            body.impersonating .main-content {
                margin-top: 40px;
            }
        </style>
        <script>document.body.classList.add('impersonating');</script>
        <% } %>

            <!-- Global Alert Banner -->
            <% if (typeof globalAlert !=='undefined' && globalAlert && globalAlert.message) { %>
                <div class="global-alert global-alert-<%= globalAlert.type || 'info' %>">
                    <div class="global-alert-content">
                        <% if (globalAlert.type==='warning' ) { %>
                            <i class="fa-solid fa-triangle-exclamation"></i>
                            <% } else if (globalAlert.type==='danger' ) { %>
                                <i class="fa-solid fa-circle-exclamation"></i>
                                <% } else { %>
                                    <i class="fa-solid fa-circle-info"></i>
                                    <% } %>
                                        <span>
                                            <%= globalAlert.message %>
                                        </span>
                    </div>
                </div>
                <style>
                    .global-alert {
                        padding: 0.75rem 1rem;
                        text-align: center;
                        font-size: 0.9rem;
                        font-weight: 500;
                    }

                    .global-alert-content {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        gap: 0.75rem;
                    }

                    .global-alert-info {
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        color: white;
                    }

                    .global-alert-warning {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                    }

                    .global-alert-danger {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                    }
                </style>
                <% } %>